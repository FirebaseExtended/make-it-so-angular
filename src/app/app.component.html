<div class="site-layout">
  <div class="min-h-[100vh] h-full w-full py-10 flex bg-[#ffe2ad] p-6">
    <!-- Sidebar -->
    <div
      class="w-16 h-full flex flex-col items-center justify-between py-4 rounded-lg mr-4"
    >
      <button
        class="rounded-full w-12 h-12 bg-gradient-to-tl to-yellow-300 from-red-600 flex items-center justify-center m-4"
        title="New task"
        (click)="this.generateMainTask()"
      >
        <mat-icon class="text-white font-extrabold">add</mat-icon>
      </button>
      <button
        class="rounded-lg w-12 h-12 bg-gradient-to-tl from-sky-300 to-blue-700 flex items-center justify-center m-4"
        (click)="fileInput.click()"
        title="New Task From Image"
      >
        <mat-icon class="text-white">add_a_photo</mat-icon>
      </button>
      <input
        type="file"
        accept="image/*"
        (change)="generateMainWithSubTaskFromImage($event)"
        hidden
        #fileInput
      />
    </div>

    <!-- Main Content -->
    <div class="flex flex-col w-full space-y-4 space-x-4">
      <!-- <div class="flex justify-end items-center mb-4 mx-8">
        <button mat-icon-button [matMenuTriggerFor]="settingsMenu">
          <mat-icon class="text-gray-600 material-icons-outlined"
            >settings</mat-icon
          >
        </button>
        <mat-menu #settingsMenu="matMenu">
          <button
            mat-menu-item
            class="text-gray-800 hover:bg-gray-100"
            (click)="this.todoService.logout()"
          >
            Sign Out
          </button>
        </mat-menu>
      </div> -->

      <!-- Task Grid -->
      <div class="container mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 bg-white rounded-3xl p-6 min-h-[91vh] shadow-xl">
          @for (todo of this.todos; track todo.maintask.id) {
          <div class="bg-[#F3F5F7] p-6 rounded-3xl relative min-w-80 overflow-y-scroll max-h-80">
            <div class="flex justify-between items-center mb-4">
              <div class="flex items-center">
                <mat-checkbox
                  (click)="updateComplete(todo.maintask)"
                  [checked]="todo.maintask.completed"
                  class="text-[#5A94E2]"
                ></mat-checkbox>
                <h3 class="ml-4 text-lg font-medium text-[#333]">
                  {{ todo.maintask.title }}
                </h3>
              </div>
              <div
                class="py-2 px-3 text-white text-sm font-bold rounded-2xl"
                [ngClass]="{
                  'bg-red-300 text-red-900 px-4':
                    todo.maintask.priority.toLowerCase() == 'high',
                  'bg-amber-300 text-amber-900':
                    todo.maintask.priority.toLowerCase() == 'medium',
                  'bg-green-300 text-green-800 px-5':
                    todo.maintask.priority.toLowerCase() == 'low',
                  'bg-gray-300 text-gray-700 px-4':
                    todo.maintask.priority.toLowerCase() == 'none'
                }"
              >
                {{ todo.maintask.priority | titlecase }}
              </div>
              <button
                mat-icon-button
                [matMenuTriggerFor]="taskMenu"
                class="absolute right-2"
              >
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #taskMenu="matMenu">
                <button mat-menu-item (click)="openEditor(todo.maintask)">
                  <mat-icon class="text-gray-600 material-icons-outlined"
                    >edit</mat-icon
                  >
                  Edit
                </button>
                <button mat-menu-item (click)="deleteTask(todo.maintask)">
                  <mat-icon class="text-gray-600 material-icons-outlined"
                    >delete</mat-icon
                  >
                  Delete
                </button>
              </mat-menu>
            </div>

            <!-- Subtasks as list items inside the main task card -->
            <ul class="mt-4 space-y-2">
              @for(subtask of todo.subtasks; track subtask.id) {
              <li class="flex items-center">
                <mat-checkbox
                  (click)="updateComplete(subtask)"
                  [checked]="subtask.completed"
                  class="text-gray-500"
                ></mat-checkbox>
                <p
                  class="ml-2 text-gray-600 {{
                    subtask.completed ? 'line-through' : ''
                  }}"
                >
                  {{ subtask.title }}
                </p>
              </li>
              }
            </ul>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Task Editor -->
    @if (showEditor) {
    <div
      class="w-full md:w-1/2 p-6 bg-white transition-all duration-300 ease-in-out rounded-3xl relative shadow-xl"
    >
      <button (click)="closeEditor()" class="absolute top-3 right-4  m-4">
        <mat-icon>close</mat-icon>
      </button>
      <button
        type="submit"
        class="absolute top-2 right-20 bg-orange-200 rounded-3xl w-20 h-8 flex items-center justify-center m-4 text-xs font-medium"
        (click)="submit()"
      >
        Save
      </button>

      <h2 class="text-xl font-bold mb-4">
        {{ selectedTaskId ? "Edit Task" : "New Task" }}
      </h2>

      <form [formGroup]="taskForm" (ngSubmit)="submit()">
        <mat-form-field class="w-full mb-4">
          <mat-label>Title</mat-label>
          <input
            matInput
            formControlName="title"
            placeholder="Develop the app"
          />
        </mat-form-field>

        <div class="flex space-x-4 mb-4">
          <mat-form-field>
            <mat-label>Date</mat-label>
            <input
              matInput
              [matDatepicker]="picker"
              formControlName="dueDate"
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="picker"
            ></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
        </div>
        <div class="flex items-center mb-4 justify-between">
          <span>Priority</span>
          <mat-button-toggle-group formControlName="priority" class="mb-4">
            <mat-button-toggle value="High">High</mat-button-toggle>
            <mat-button-toggle value="Medium">Medium</mat-button-toggle>
            <mat-button-toggle value="Low">Low</mat-button-toggle>
            <mat-button-toggle value="None">None</mat-button-toggle>
          </mat-button-toggle-group>
        </div>
        <mat-slide-toggle formControlName="flagged">Flag</mat-slide-toggle>

        <div class="mt-6">
          <h3 class="text-lg font-medium">Subtasks</h3>
          <div class="flex items-center space-x-2 mb-4">
            <input
              matInput
              [(ngModel)]="newSubtaskTitle"
              [ngModelOptions]="{ standalone: true }"
              placeholder="New subtask title"
              class="w-full p-2 border rounded"
            />
            <button
              (click)="
                addSubtask(); $event.stopPropagation(); $event.preventDefault()
              "
              class="border-2 border-blue-200 rounded-3xl p-2 text-blue-600"
            >
              +
            </button>
          </div>
          <div class="flex items-center space-x-2 mb-4">
            <button
              (click)="
                moreSubtaskInput.click();
                $event.stopPropagation();
                $event.preventDefault()
              "
              class="text-sm border-2 border-sky-200 rounded-lg p-2"
            >
            <mat-icon class="text-blue-500">add_photo_alternate</mat-icon>
              From Image
            </button>
            <input
              type="file"
              accept="image/*"
              (change)="generateSubtasksFromImage($event)"
              hidden
              #moreSubtaskInput
            />
            <button
              (click)="
                generateSubtasksFromTitle();
                $event.stopPropagation();
                $event.preventDefault()
              "
              class="text-sm border-2 border-sky-200 rounded-lg p-2"
            >
            <mat-icon class="text-blue-500">format_list_bulleted_add</mat-icon>
              From Title
            </button>
          </div>

          <ul class="mt-4 space-y-2">
            @for (subtask of this.subtasks; track subtask.todo.id) {
            <li class="flex items-center">
              <mat-checkbox
                (click)="updateComplete(subtask.todo)"
                value="subtask.todo.completed"
                class="text-orange-500"
              ></mat-checkbox>
              @if(subtask.editing) {
              <input
                [(ngModel)]="subtask.todo.title"
                class="ml-2 w-full p-2 border rounded"
              />
              } @if(!subtask.editing) {
              <p class="ml-2">{{ subtask.todo.title }}</p>
              }
              <button
                mat-icon-button
                [matMenuTriggerFor]="subtaskMenu"
                (click)="$event.stopPropagation(); $event.preventDefault()"
              >
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #subtaskMenu="matMenu">
                <button mat-menu-item (click)="moveSubtaskUp(subtask)">
                  <mat-icon class="text-gray-600 material-icons-outlined"
                    >keyboard_arrow_up</mat-icon
                  >
                  Move order up
                </button>
                <button mat-menu-item (click)="moveSubtaskDown(subtask)">
                  <mat-icon class="text-gray-600 material-icons-outlined"
                    >keyboard_arrow_down</mat-icon
                  >
                  Move order down
                </button>
                <button mat-menu-item (click)="this.deleteSubtask(subtask)">
                  <mat-icon class="text-gray-600 material-icons-outlined"
                    >delete</mat-icon
                  >
                  Delete
                </button>
              </mat-menu>
            </li>
            }
          </ul>
        </div>
      </form>
    </div>
    }
  </div>
</div>
